<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Gá»­i Nguyá»…n LÃª Báº£o KhuyÃªn ğŸ˜‰</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Fredoka:wght@400;600&family=Dancing+Script:wght@700&display=swap');
        
        :root {
            --yes-scale: 1;
        }

        body {
            font-family: 'Fredoka', sans-serif;
            background: linear-gradient(135deg, #0a0002 0%, #3e0015 25%, #1a0008 50%, #5c001f 75%, #0a0002 100%);
            background-size: 400% 400%;
            animation: gradientBG 6s ease infinite;
            margin: 0;
            padding: 0;
            overflow: hidden;
            touch-action: none;
            color: white;
        }

        @keyframes gradientBG {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }

        .cursive {
            font-family: 'Dancing Script', cursive;
        }

        .photo-frame {
            border: 8px solid white;
            border-bottom: 40px solid white;
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.4);
            transition: all 0.8s cubic-bezier(0.34, 1.56, 0.64, 1);
            background-color: white;
            object-fit: cover;
        }

        .heart-bg {
            position: fixed;
            inset: 0;
            pointer-events: none;
            z-index: 0;
        }
        
        .raining-item {
            position: absolute;
            top: -50px;
            animation: fallDown linear forwards;
            opacity: 0;
            z-index: 10;
            filter: drop-shadow(0 2px 4px rgba(244, 63, 94, 0.2));
            pointer-events: none;
        }

        /* Wedding scene raindrops */
        .raindrop {
            position: absolute;
            background: linear-gradient(to bottom, rgba(255, 255, 255, 0) 0%, rgba(255, 255, 255, 0.6) 100%);
            width: 2px;
            height: 80px;
            top: -100px;
            animation: fallDown linear forwards;
            z-index: 1;
            pointer-events: none;
            box-shadow: 0 0 5px rgba(255, 255, 255, 0.3);
        }

        @keyframes fallDown {
            0% { transform: translateY(-10vh); opacity: 0; }
            10% { opacity: 1; }
            90% { opacity: 1; }
            100% { transform: translateY(110vh); opacity: 0; }
        }

        #noBtn {
            transition: all 0.15s ease-out;
            z-index: 50;
        }

        @keyframes pulseHeart {
            0% { transform: scale(var(--yes-scale)); box-shadow: 0 0 0 0 rgba(225, 29, 72, 0.9); }
            50% { transform: scale(calc(var(--yes-scale) * 1.15)); box-shadow: 0 0 30px 15px rgba(225, 29, 72, 0.9), 0 0 60px 30px rgba(159, 18, 57, 0.8); }
            100% { transform: scale(var(--yes-scale)); box-shadow: 0 0 0 0 rgba(225, 29, 72, 0); }
        }

        /* Ultra-Low Intensity Bloom Reveal Animation */
        @keyframes bloomReveal {
            0% { opacity: 0; transform: scale(0.995) translateY(2px); filter: blur(2px); }
            100% { opacity: 1; transform: scale(1) translateY(0); filter: blur(0); }
        }

        .celebrate-entrance {
            animation: bloomReveal 1.5s cubic-bezier(0.22, 0.61, 0.36, 1) forwards;
        }

        .voucher-card {
            background: #fff;
            background-image: radial-gradient(#fecdd3 1px, transparent 1px);
            background-size: 15px 15px;
            border: 2px dashed #fb7185;
            color: #333;
        }

        .stamp {
            position: absolute;
            top: 10px;
            right: 10px;
            width: 60px;
            height: 60px;
            border: 3px solid #e11d48;
            border-radius: 50%;
            color: #e11d48;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 10px;
            transform: rotate(-15deg);
            opacity: 0.3;
            pointer-events: none;
        }

        .wedding-bg {
            background: linear-gradient(rgba(0, 0, 0, 0.6), rgba(0, 0, 0, 0.6)), 
                        url('https://i.postimg.cc/RF8y08Bd/download.jpg');
            background-size: cover;
            background-position: center;
            color: white;
        }

        @keyframes bellSway {
            0%, 100% { transform: rotate(-15deg); }
            50% { transform: rotate(15deg); }
        }

        .wedding-bell {
            animation: bellSway 2s ease-in-out infinite;
            display: inline-block;
            font-size: 2.5rem;
        }

        .marriage-cert {
            background: linear-gradient(rgba(255, 255, 255, 0.95), rgba(255, 255, 255, 0.95)), 
                        url('https://images.unsplash.com/photo-1511795409834-ef04bbd61622?q=80&w=1000&auto=format&fit=crop');
            background-size: cover;
            background-position: center;
            border: 6px double #be123c;
            padding: 1.25rem 1rem;
            position: relative;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
            color: #881337;
            z-index: 10;
        }

        @media (min-width: 640px) {
            .wedding-bell { font-size: 4rem; }
            .marriage-cert { padding: 2.5rem 1.5rem; border-width: 10px; }
        }

        @keyframes subtleFloat {
            0%, 100% { transform: rotate(-4deg) translateY(0) scale(1); }
            50% { transform: rotate(4deg) translateY(-20px) scale(1.04); }
        }
    </style>
</head>
<body class="h-screen w-full flex flex-col items-center justify-center p-4 overflow-hidden">

    <!-- Lá»šP PHá»¦ Lá»I VÃ€O -->
    <div id="entry-overlay" class="fixed inset-0 bg-black z-[200] flex flex-col items-center justify-center transition-opacity duration-1000">
        <h2 class="cursive text-4xl sm:text-6xl text-rose-500 mb-8 animate-pulse text-center px-4">
            Anh cÃ³ Ä‘iá»u nÃ y muá»‘n há»i em...
        </h2>
        <button id="entry-btn" onclick="startProposal()" class="bg-rose-700 hover:bg-rose-600 text-white font-bold py-4 px-10 rounded-full shadow-[0_0_40px_rgba(225,29,72,0.6)] transform transition-all duration-300 hover:scale-110 active:scale-95 text-xl border-2 border-rose-400">
            Cháº¡m Ä‘á»ƒ má»Ÿ ğŸ’Œ
        </button>
    </div>

    <div id="heart-bg" class="heart-bg"></div>

    <!-- CHáº¾ Äá»˜ Cáº¦U HÃ”N -->
    <div id="proposal-view" class="relative z-10 text-center max-w-lg w-full flex flex-col items-center opacity-0 transition-opacity duration-1000 hidden">
        <div id="content-container" class="flex flex-col items-center w-full transition-all duration-700">
            <div id="imageWrapper" class="mb-8 flex flex-row justify-center items-center gap-3 sm:gap-6 w-full px-2 transition-all duration-700">
                <!-- Applied matching aspect-ratio and size classes to make them equally large -->
                <img id="mainImage" src="https://i.postimg.cc/yNgXVmr1/IMG-6102.avif" alt="áº¢nh 1" class="photo-frame w-[45%] sm:w-60 aspect-[3/4]" style="animation: subtleFloat 3.5s ease-in-out infinite;">
                <img id="secondImage" src="https://i.postimg.cc/W3pS7LLw/525024E0-EBDF-4916-B584-AB16AE032F6A.jpg" alt="áº¢nh 2" class="photo-frame w-[45%] sm:w-60 aspect-[3/4]" style="animation: subtleFloat 4s ease-in-out infinite reverse;">
            </div>

            <h1 id="question" class="cursive text-3xl sm:text-4xl font-bold text-white mb-8 leading-tight drop-shadow-lg px-4 transition-all duration-500">
                Nguyá»…n LÃª Báº£o KhuyÃªn lÃ m báº¡n gÃ¡i anh nha rá»“i cho anh lÃ m â€˜Ä‘á»“ Ä‘Ã¡ng ghÃ©tâ€™ cá»§a riÃªng em Ä‘Æ°á»£c khÃ´ng? ğŸ˜‰
            </h1>

            <div id="buttonContainer" class="flex flex-row justify-center items-center gap-6 min-h-[120px] w-full relative transition-all duration-500">
                <button id="yesBtn" onclick="handleYes()" class="bg-rose-600 hover:bg-rose-700 text-white font-bold py-4 px-10 rounded-full text-xl z-20 shadow-lg transition-all duration-200" style="animation: pulseHeart 1.2s infinite;">
                    Äá»“ng Ã½
                </button>
                <button id="noBtn" onmouseover="evadeButton()" ontouchstart="evadeButton()" onclick="evadeButton()" class="bg-rose-300 text-white font-bold py-4 px-10 rounded-full text-xl shadow-lg">
                    KhÃ´ng
                </button>
            </div>
        </div>
    </div>

    <!-- CHáº¾ Äá»˜ VOUCHER -->
    <div id="voucher-view" class="p-4 w-full flex-col items-center hidden opacity-0 transition-opacity duration-1000 z-50">
        <div id="voucher-card" class="voucher-card w-full max-w-sm p-6 rounded-xl mb-8 relative shadow-2xl text-center">
            <div class="border-b-2 border-rose-200 pb-3 mb-4">
                <h2 class="cursive text-3xl text-rose-600 font-bold">Valentine's Voucher</h2>
                <p class="text-rose-400 text-[10px] tracking-widest font-bold">CHá»¨NG NHáº¬N Háº¸N HÃ’ CHÃNH THá»¨C</p>
            </div>
            
            <p class="text-gray-700 text-sm sm:text-base leading-relaxed mb-6 italic px-2">
                "Xin lá»—i vÃ¬ anh Ä‘Ã£ Ä‘áº¿n muá»™n vÃ  khÃ´ng thá»ƒ á»Ÿ bÃªn em vÃ o dá»‹p Valentine nÃ y. NhÆ°ng hÃ£y Ä‘á»ƒ voucher nÃ y nhÆ° má»™t lá»i há»©a tá»« anh: VÃ o táº¥t cáº£ cÃ¡c ngÃ y Valentine vÃ  nhá»¯ng dá»‹p Ä‘áº·c biá»‡t sáº¯p tá»›i, anh sáº½ luÃ´n á»Ÿ bÃªn em. VÃ  Ä‘Ã¢y cÅ©ng lÃ  báº±ng chá»©ng cho má»™t bá»¯a tá»‘i Valentine mÃ  anh ná»£ em nhÃ© ğŸ˜œğŸ’•"
            </p>

            <div class="bg-rose-50 rounded-lg p-4 border border-rose-100 flex flex-col gap-2 text-left">
                <div class="flex justify-between items-center border-b border-rose-100 pb-1">
                    <span class="text-[10px] text-rose-400 font-bold">NGÆ¯á»œI Cáº¤P:</span>
                    <span class="font-bold text-gray-800">DongHui â¤ï¸</span>
                </div>
                <div class="flex justify-between items-start pt-1">
                    <span class="text-[10px] text-rose-400 font-bold shrink-0">DÃ€NH CHO:</span>
                    <span class="font-bold text-gray-800 text-xs text-right ml-4 leading-tight">Nguyá»…n LÃª Báº£o KhuyÃªn</span>
                </div>
            </div>
            <div class="stamp">OFFICIAL<br>LOVE</div>
        </div>

        <button onclick="downloadVoucher()" id="saveBtn" class="bg-rose-600 text-white font-bold py-4 px-10 rounded-full shadow-xl hover:bg-rose-700 mb-4 text-lg transition-all active:scale-95 flex items-center gap-2">
            <span>ğŸ“¸</span> LÆ°u hÃ¬nh áº£nh
        </button>
        <button onclick="location.reload()" class="text-rose-400 underline text-sm">ChÆ¡i láº¡i</button>
    </div>

    <!-- CHáº¾ Äá»˜ ÄÃM CÆ¯á»šI -->
    <div id="wedding-view" class="fixed inset-0 wedding-bg hidden opacity-0 transition-opacity duration-1000 flex flex-col items-center sm:items-end justify-center p-4 sm:p-6 sm:pr-20 z-[150] text-center">
        <div id="wedding-rain-container" class="absolute inset-0 pointer-events-none overflow-hidden z-0"></div>
        
        <div class="marriage-cert w-[88%] sm:w-[92%] max-w-md rounded-lg relative z-10">
            <div class="mb-2 sm:mb-4">
                <span class="wedding-bell">ğŸ””</span>
                <span class="wedding-bell" style="animation-delay: 0.5s;">ğŸ””</span>
            </div>
            
            <h2 class="cursive text-2xl sm:text-5xl mb-2 sm:mb-4 font-bold">Giáº¥y Chá»©ng Nháº­n Káº¿t HÃ´n</h2>
            <div class="h-px bg-rose-300 w-full mb-3 sm:mb-6"></div>
            
            <p class="text-xs sm:text-lg mb-1 sm:mb-4 font-medium uppercase tracking-tight">VÄƒn báº£n nÃ y chá»©ng nháº­n ráº±ng</p>
            <p class="cursive text-2xl sm:text-4xl font-bold text-rose-800 mb-1 sm:mb-2">Nguyá»…n LÃª Báº£o KhuyÃªn</p>
            <p class="text-[10px] sm:text-base mb-1 sm:mb-2 font-medium">Ä‘Ã£ chÃ­nh thá»©c sá»Ÿ há»¯u</p>
            <p class="cursive text-2xl sm:text-4xl font-bold text-rose-800 mb-3 sm:mb-6">'Äá»“ Ä‘Ã¡ng ghÃ©t' DongHui</p>
            
            <p class="italic text-[10px] sm:text-sm text-gray-800 mb-3 sm:mb-6 font-medium bg-white/60 rounded py-1.5 px-2">"Giá» Ä‘Ã¢y hai báº¡n cÃ³ thá»ƒ trao nhau ná»¥ hÃ´n vÃ  táº­n hÆ°á»Ÿng háº¡nh phÃºc trá»n Ä‘á»i."</p>
            
            <div class="flex justify-around items-center text-xl sm:text-4xl mb-1 sm:mb-4">
                <span>ğŸ’</span>
                <span class="text-rose-600">â¤ï¸</span>
                <span>ğŸ’</span>
            </div>
        </div>
        
        <p class="mt-4 sm:mt-8 cursive text-lg sm:text-3xl animate-bounce text-white font-bold drop-shadow-lg relative z-10">Sá»›m Ä‘i hÆ°á»Ÿng tuáº§n trÄƒng máº­t thÃ´i em Æ¡i! Em thÃ­ch Ä‘i nÆ°á»›c nÃ o cá»© chá»n nha ğŸ˜œ</p>
        <button onclick="location.reload()" class="mt-3 sm:mt-8 bg-white/20 backdrop-blur-md text-white px-6 sm:px-8 py-2 sm:py-3 rounded-full text-xs sm:text-sm font-bold shadow-lg border border-white/30 hover:bg-white/30 transition-all relative z-10">Quay láº¡i</button>
    </div>

    <!-- Modal káº¿t quáº£ -->
    <div id="result-modal" class="fixed inset-0 bg-black/90 z-[300] hidden flex-col items-center justify-center p-4 backdrop-blur-md">
        <div class="bg-white p-6 rounded-2xl max-w-sm w-full text-center relative shadow-2xl">
            <button onclick="closeModal()" class="absolute top-4 right-4 text-gray-400 text-2xl">&times;</button>
            <h3 class="text-rose-600 font-bold text-2xl mb-2 cursive">Voucher Ä‘Ã£ sáºµn sÃ ng!</h3>
            <p class="text-gray-500 text-xs mb-4">Nháº¥n giá»¯ hÃ¬nh áº£nh Ä‘á»ƒ lÆ°u vÃ o Ä‘iá»‡n thoáº¡i</p>
            <div class="border border-rose-100 rounded-lg overflow-hidden">
                <img id="generated-image" class="w-full h-auto" alt="Voucher">
            </div>
            <a id="download-link" class="block mt-4 text-rose-500 underline text-sm font-bold">Táº£i file vá»</a>
        </div>
    </div>

    <audio id="bgMusic" loop src="https://www.dropbox.com/scl/fi/l37yuc90otnssil6h58xk/RINI-Red-Lights-ft.-Wale-Official-Lyric-Video.mp3?rlkey=wmqjwhb4ikgphtdqh5x0szwg2&st=i2dgjeq4&raw=1"></audio>

    <button id="musicToggle" onclick="toggleMusic()" class="fixed bottom-6 right-6 z-[100] bg-black/50 text-white w-10 h-10 rounded-full flex items-center justify-center text-lg border border-white/20">
        <span id="musicIcon">ğŸ”‡</span>
    </button>

    <script>
        const bgMusic = document.getElementById('bgMusic');
        const musicIcon = document.getElementById('musicIcon');
        const entryOverlay = document.getElementById('entry-overlay');
        const proposalView = document.getElementById('proposal-view');
        const voucherView = document.getElementById('voucher-view');
        const weddingView = document.getElementById('wedding-view');
        const weddingRainContainer = document.getElementById('wedding-rain-container');
        const noBtn = document.getElementById('noBtn');
        const yesBtn = document.getElementById('yesBtn');
        const questionText = document.getElementById('question');
        const buttonContainer = document.getElementById('buttonContainer');
        const contentContainer = document.getElementById('content-container');
        const heartBg = document.getElementById('heart-bg');
        
        let isMusicPlaying = false;
        let noTriggerCount = 0;
        let rainingIcons = ['ğŸ’‹', 'ğŸ”¥', 'ğŸŒ¶ï¸', 'ğŸ¥µ', 'ğŸ˜', 'â¤ï¸â€ğŸ”¥', 'ğŸ˜ˆ', 'â›“ï¸', 'ğŸ–¤', 'ğŸ’¦'];
        let isWeddingMode = false;

        const persuadeMessages = [
            "Em cháº¯c chÆ°a? ğŸ¥º",
            "Tháº­t sá»± cháº¯c cháº¯n sao? ğŸ˜¢",
            "NghÄ© láº¡i Ä‘i mÃ ! ğŸ˜­",
            "NhÆ°ng anh lÃ  'Ä‘á»“ Ä‘Ã¡ng ghÃ©t' cá»§a em mÃ ! ğŸ˜ˆ",
            "Äá»«ng lÃ m tan nÃ¡t trÃ¡i tim anh... ğŸ’”",
            "Anh sáº½ buá»“n láº¯m Ä‘Ã³... ğŸ˜¿",
            "NhÃ¬n áº£nh chÃºng mÃ¬nh láº¡i Ä‘i! â¤ï¸",
            "Báº¥m 'Äá»“ng Ã½' Ä‘i mÃ  em yÃªu! ğŸ˜˜",
            "Anh khÃ´ng cho em nÃ³i khÃ´ng Ä‘Ã¢u! ğŸ˜‚"
        ];

        document.addEventListener('mousemove', handleProximity);
        document.addEventListener('touchmove', handleProximity);

        function handleProximity(e) {
            if (!noBtn || questionText.innerText.includes("Yaysss")) return;
            let x = e.clientX || (e.touches && e.touches[0].clientX);
            let y = e.clientY || (e.touches && e.touches[0].clientY);
            const rect = noBtn.getBoundingClientRect();
            const centerX = rect.left + rect.width / 2;
            const centerY = rect.top + rect.height / 2;
            const dist = Math.sqrt(Math.pow(x - centerX, 2) + Math.pow(y - centerY, 2));
            if (dist < 100) evadeButton();
        }

        function evadeButton() {
            if (questionText.innerText.includes("Yaysss")) return;
            const x = Math.random() * (window.innerWidth - 120) + 60;
            const y = Math.random() * (window.innerHeight - 80) + 40;
            noBtn.style.position = 'fixed';
            noBtn.style.left = `${x}px`;
            noBtn.style.top = `${y}px`;
            noTriggerCount++;
            const msgIndex = Math.min(noTriggerCount - 1, persuadeMessages.length - 1);
            questionText.innerText = persuadeMessages[msgIndex];
            const newScale = Math.min(1 + (noTriggerCount * 0.08), 3.5);
            document.documentElement.style.setProperty('--yes-scale', newScale);
            yesBtn.style.fontSize = (20 + noTriggerCount * 1) + 'px';
        }

        function startProposal() {
            bgMusic.play().then(() => {
                isMusicPlaying = true;
                musicIcon.innerText = 'ğŸ”Š';
            }).catch(err => console.log("Music blocked"));
            entryOverlay.style.opacity = '0';
            setTimeout(() => {
                entryOverlay.style.display = 'none';
                proposalView.classList.remove('hidden');
                setTimeout(() => proposalView.style.opacity = '1', 50);
            }, 1000);
            
            setInterval(() => {
                createRainItem();
                if (isWeddingMode) createRaindrop();
            }, 350); 
        }

        function toggleMusic() {
            if (isMusicPlaying) {
                bgMusic.pause();
                musicIcon.innerText = 'ğŸ”‡';
            } else {
                bgMusic.play().catch(() => {});
                musicIcon.innerText = 'ğŸ”Š';
            }
            isMusicPlaying = !isMusicPlaying;
        }

        function handleYes() {
            const mainImg = document.getElementById('mainImage');
            const secImg = document.getElementById('secondImage');
            
            contentContainer.style.transition = "all 0.5s ease-in-out";
            contentContainer.style.opacity = '0';
            contentContainer.style.filter = 'blur(2px)';
            
            setTimeout(() => {
                document.documentElement.style.setProperty('--yes-scale', 1);
                mainImg.src = "https://media.tenor.com/gUiu1zyxfzYAAAAi/bear-kiss-bear-kisses.gif";
                mainImg.style.width = "75%";
                mainImg.style.animation = "none";
                mainImg.style.transform = "rotate(0deg)";
                if (secImg) secImg.style.display = 'none';

                questionText.innerText = "Yaysss!! Anh nhá»› em nhiá»u láº¯m Su! Háº¹n sá»›m gáº·p em á»Ÿ HCMC nhÃ©! Anh Ä‘ang ráº¥t hÃ o há»©ng vÃ  mong chá» chuyáº¿n Ä‘i cá»§a chÃºng mÃ¬nh. Anh yÃªu em ğŸ’•";
                questionText.className = "cursive text-2xl sm:text-4xl text-rose-300 mt-6 leading-relaxed px-4 text-center";
                
                noBtn.remove();
                buttonContainer.innerHTML = '';
                
                contentContainer.style.filter = 'blur(0px)';
                contentContainer.classList.add('celebrate-entrance');
                contentContainer.style.opacity = '1';

                for(let i=0; i<60; i++) {
                    setTimeout(createRainItem, i * 40);
                }

                setTimeout(() => {
                    const nextBtn = document.createElement('button');
                    nextBtn.innerHTML = "Nháº­n pháº§n thÆ°á»Ÿng ğŸ˜ˆâ›“ï¸";
                    nextBtn.className = "bg-white text-rose-600 font-bold py-4 px-10 rounded-full shadow-2xl border-2 border-rose-600 mt-8 z-50 relative celebrate-entrance";
                    nextBtn.style.animationDelay = "0.5s";
                    nextBtn.onclick = () => {
                        proposalView.style.opacity = '0';
                        setTimeout(() => {
                            proposalView.classList.add('hidden');
                            voucherView.classList.remove('hidden');
                            voucherView.classList.add('flex');
                            setTimeout(() => voucherView.style.opacity = '1', 50);
                        }, 1000);
                    };
                    buttonContainer.appendChild(nextBtn);
                }, 1800);
            }, 600);
        }

        function createRainItem() {
            const item = document.createElement('div');
            item.className = 'raining-item';
            item.innerText = rainingIcons[Math.floor(Math.random() * rainingIcons.length)];
            item.style.left = Math.random() * 100 + 'vw';
            item.style.fontSize = Math.random() * 15 + 15 + 'px'; 
            item.style.animationDuration = Math.random() * 2 + 3 + 's'; 
            heartBg.appendChild(item);
            setTimeout(() => item.remove(), 5000);
        }

        function createRaindrop() {
            const drop = document.createElement('div');
            drop.className = 'raindrop';
            drop.style.left = Math.random() * 100 + 'vw';
            const height = Math.random() * 40 + 40; 
            const duration = Math.random() * 0.4 + 0.6;
            drop.style.height = height + 'px';
            drop.style.animationDuration = duration + 's';
            weddingRainContainer.appendChild(drop);
            setTimeout(() => drop.remove(), duration * 1000);
        }

        function downloadVoucher() {
            const card = document.getElementById('voucher-card');
            const btn = document.getElementById('saveBtn');
            const originalBtnText = btn.innerHTML;
            btn.innerHTML = "â³ Äang xá»­ lÃ½...";
            
            const originalTransform = card.style.transform;
            card.style.transform = 'none';

            const width = card.offsetWidth;
            const height = card.offsetHeight;

            html2canvas(card, { 
                scale: 3, 
                backgroundColor: '#ffffff', 
                useCORS: true,
                logging: false,
                width: width,
                height: height,
                scrollX: 0,
                scrollY: -window.pageYOffset,
                onclone: (clonedDoc) => {
                    const clonedCard = clonedDoc.getElementById('voucher-card');
                    clonedCard.style.margin = "0";
                    clonedCard.style.transform = "none";
                    clonedCard.style.width = width + "px";
                    const nameSpan = clonedCard.querySelector('.text-right');
                    if (nameSpan) {
                        nameSpan.style.whiteSpace = 'normal';
                        nameSpan.style.overflow = 'visible';
                    }
                }
            }).then(canvas => {
                card.style.transform = originalTransform;
                const dataUrl = canvas.toDataURL('image/png');
                
                canvas.toBlob(async (blob) => {
                    const file = new File([blob], "ValentineVoucher.png", { type: "image/png" });
                    
                    if (navigator.share && navigator.canShare && navigator.canShare({ files: [file] })) {
                        try {
                            await navigator.share({ files: [file], title: 'Valentine Voucher' });
                            btn.innerHTML = originalBtnText;
                            prepareWeddingTransition();
                        } catch (err) {
                            btn.innerHTML = originalBtnText;
                            if (err.name !== 'AbortError') showModalFallback(dataUrl);
                        }
                    } else {
                        btn.innerHTML = originalBtnText;
                        showModalFallback(dataUrl);
                    }
                }, 'image/png');
            }).catch(err => {
                console.error("Lá»—i:", err);
                btn.innerHTML = "âŒ Lá»—i";
                setTimeout(() => btn.innerHTML = originalBtnText, 2000);
            });
        }

        function showModalFallback(dataUrl) {
            const modal = document.getElementById('result-modal');
            const genImg = document.getElementById('generated-image');
            const downloadLink = document.getElementById('download-link');
            genImg.src = dataUrl;
            downloadLink.href = dataUrl;
            downloadLink.download = "ValentineVoucher.png";
            modal.classList.remove('hidden');
            modal.classList.add('flex');
            prepareWeddingTransition();
        }

        function prepareWeddingTransition() {
            const btn = document.getElementById('saveBtn');
            btn.innerHTML = "Tiáº¿n hÃ nh hÃ´n lá»… ğŸ’’ğŸ’";
            btn.className = "bg-rose-900 text-white font-bold py-4 px-10 rounded-full shadow-[0_0_30px_rgba(255,255,255,0.8)] border-2 border-white mt-4 animate-bounce";
            btn.onclick = startWeddingScene;
        }

        function startWeddingScene() {
            voucherView.style.opacity = '0';
            closeModal();
            isWeddingMode = true;
            setTimeout(() => {
                voucherView.classList.add('hidden');
                rainingIcons = ['ğŸ’', 'ğŸ’', 'ğŸ””', 'â›ª', 'ğŸ¤', 'ğŸ¥‚', 'ğŸŒ¹', 'ğŸ‘°', 'ğŸ¤µ'];
                weddingView.classList.remove('hidden');
                setTimeout(() => weddingView.style.opacity = '1', 50);
                for(let i=0; i<25; i++) setTimeout(createRaindrop, i * 40);
            }, 1000);
        }

        function closeModal() {
            document.getElementById('result-modal').classList.add('hidden');
        }
    </script>
</body>
</html>
